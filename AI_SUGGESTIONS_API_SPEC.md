# AI推論API仕様書

## 概要

ユーザーがダッシュボードで入力したプロジェクト説明（セクション0データ）を基に、AIがセクション1（課題とターゲット）とセクション2（プロダクト詳細）の推奨回答を自動生成するAPIです。

## エンドポイント

```
POST /api/v1/generation/{sessionId}/ai-suggestions
```

## 認証

- **必須**: Bearer Token（JWTトークン）
- Authorizationヘッダー: `Authorization: Bearer {access_token}`

## パス パラメータ

| パラメータ名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| sessionId | string | ✓ | セッションID（UUID形式） |

## リクエスト

### メソッド
`POST`

### ヘッダー
```
Content-Type: application/json
Authorization: Bearer {access_token}
```

### ボディ
リクエストボディは不要です。セッションIDに紐づくセクション0データ（project_description）を使用します。

## レスポンス

### 成功時（200 OK）

```json
{
  "success": true,
  "sessionId": "8cd757f3-b508-444a-92f8-8dec84695b41",
  "suggestions": {
    "section1": {
      "problem_type": "業務効率化",
      "problem_details": ["時間不足", "情報過多"],
      "target_user": "個人",
      "target_attributes": "30代・働き盛り",
      "motivation": "効率化・時短のため"
    },
    "section2": {
      "platforms": ["Webアプリケーション", "モバイルアプリ（iOS/Android）"],
      "function_types": ["データ管理・整理", "自動化・効率化"],
      "feature_details": "AIによる自動タスク整理、優先度付け、スケジュール最適化",
      "revenue_models": ["サブスクリプション"],
      "product_features": ["使いやすさ", "処理速度の速さ"],
      "strength_details": "AIによる高精度な予測とシンプルなUI"
    }
  },
  "confidence": 0.85,
  "timestamp": "2025-11-19T11:45:32.123Z"
}
```

### エラー時

#### 400 Bad Request
セッションが見つからない、またはセクション0データが不足している場合

```json
{
  "success": false,
  "error": {
    "code": "INVALID_SESSION",
    "message": "セッションが見つからないか、プロジェクト説明が入力されていません",
    "details": {
      "sessionId": "8cd757f3-b508-444a-92f8-8dec84695b41",
      "missingData": ["project_description"]
    }
  },
  "timestamp": "2025-11-19T11:45:32.123Z"
}
```

#### 401 Unauthorized
認証に失敗した場合

```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "認証トークンが無効または期限切れです"
  },
  "timestamp": "2025-11-19T11:45:32.123Z"
}
```

#### 500 Internal Server Error
AI推論処理でエラーが発生した場合

```json
{
  "success": false,
  "error": {
    "code": "AI_INFERENCE_ERROR",
    "message": "AI推論処理中にエラーが発生しました",
    "details": {
      "reason": "OpenAI API timeout"
    }
  },
  "timestamp": "2025-11-19T11:45:32.123Z"
}
```

## データ型定義

### Section1Data（セクション1の推奨データ）

```typescript
interface Section1Suggestion {
  problem_type: string;           // 課題タイプ（下記の選択肢から選択）
  problem_details: string[];      // 課題詳細（複数選択可、下記の選択肢から選択）
  target_user: "個人" | "法人" | "その他";  // ターゲットユーザー
  target_attributes: string;      // ターゲット属性（下記の選択肢から選択）
  motivation?: string;            // 利用動機（オプション、下記の選択肢から選択）
}
```

#### problem_type の選択肢
- `"業務効率化"`
- `"学習支援"`
- `"エンタメ"`
- `"健康管理"`
- `"コミュニケーション"`
- `"買い物"`
- `"移動"`

#### problem_details の選択肢（複数選択可）
- `"時間不足"`
- `"情報過多"`
- `"コスト"`
- `"使いにくさ"`
- `"退屈さ"`

#### target_user の選択肢
- `"個人"`
- `"法人"`
- `"その他"`

#### target_attributes の選択肢（target_userに応じて変わる）

**個人の場合:**
- `"10代・学生"`
- `"20代・若手社会人"`
- `"30代・働き盛り"`
- `"40代・管理職"`
- `"50代以上・シニア"`
- `"主婦・主夫"`
- `"フリーランス"`
- `"クリエイター"`
- `"起業家"`
- `"その他"`

**法人の場合:**
- `"スタートアップ"`
- `"中小企業"`
- `"大企業"`
- `"個人事業主"`
- `"NPO・NGO"`
- `"教育機関"`
- `"医療機関"`
- `"製造業"`
- `"サービス業"`
- `"その他"`

**その他の場合:**
- `"幅広い年齢層"`
- `"特定業界特化"`
- `"地域限定"`
- `"グローバル"`
- `"ニッチ市場"`
- `"マスマーケット"`
- `"その他"`

#### motivation の選択肢（オプション）
- `"必須ツールとして"`
- `"効率化・時短のため"`
- `"楽しみ・娯楽として"`
- `"自己実現・成長のため"`
- `"問題解決のため"`
- `"コスト削減のため"`
- `"新しい体験のため"`
- `"コミュニティ参加のため"`
- `"その他"`

### Section2Data（セクション2の推奨データ）

```typescript
interface Section2Suggestion {
  platforms: string[];            // プラットフォーム（複数選択可、下記の選択肢から選択）
  function_types: string[];       // 機能タイプ（複数選択可、下記の選択肢から選択）
  feature_details: string;        // 機能詳細（自由記述、100-500文字程度）
  revenue_models: string[];       // 収益モデル（複数選択可、下記の選択肢から選択）
  product_features: string[];     // プロダクト特徴（複数選択可、下記の選択肢から選択）
  strength_details?: string;      // 強み詳細（オプション、自由記述、100-300文字程度）
}
```

#### platforms の選択肢（複数選択可）
- `"Webアプリケーション"`
- `"モバイルアプリ（iOS/Android）"`
- `"デスクトップアプリ"`
- `"ハードウェア連携"`
- `"API・SDK"`
- `"ブラウザ拡張機能"`
- `"チャットボット"`
- `"その他"`

#### function_types の選択肢（複数選択可）
- `"データ管理・整理"`
- `"分析・レポート"`
- `"コンテンツ作成・編集"`
- `"共有・コラボレーション"`
- `"学習・教育"`
- `"エンターテイメント"`
- `"購入・決済"`
- `"コミュニケーション"`
- `"自動化・効率化"`
- `"セキュリティ・管理"`
- `"その他"`

#### revenue_models の選択肢（複数選択可）
- `"無料（広告なし）"`
- `"広告収益"`
- `"サブスクリプション"`
- `"買い切り"`
- `"従量課金"`
- `"BtoB販売"`
- `"マーケットプレイス手数料"`
- `"アフィリエイト"`
- `"データ販売"`
- `"その他"`

#### product_features（strength_types）の選択肢（複数選択可）
- `"価格の安さ"`
- `"機能の豊富さ"`
- `"デザインの美しさ"`
- `"処理速度の速さ"`
- `"サポートの充実"`
- `"使いやすさ"`
- `"楽しさ・面白さ"`
- `"セキュリティの高さ"`
- `"独自性・革新性"`
- `"ブランド力"`
- `"その他"`

## 実装要件

### 1. データ取得
1. セッションIDからセクション0データを取得
2. `project_description`（プロジェクト説明）が存在することを確認
3. 存在しない場合は400エラーを返す

### 2. AI推論処理
プロジェクト説明を基に、以下の情報をAIに推論させます：

**セクション1（課題とターゲット）の推論:**
- どのような課題を解決するプロダクトか？
- 課題の具体的な詳細は何か？
- ターゲットユーザーは誰か？（個人/法人/その他）
- ターゲットユーザーの具体的な属性は？
- ユーザーの利用動機は？

**セクション2（プロダクト詳細）の推論:**
- どのプラットフォームで提供するか？
- 主な機能タイプは何か？
- 機能の具体的な詳細説明
- 収益モデルは何が適切か？
- プロダクトの主な強みは？
- 強みの具体的な説明

### 3. プロンプト設計の推奨事項

```
あなたはプロダクト企画の専門家です。以下のプロジェクト説明を分析し、セクション1とセクション2の推奨回答を生成してください。

【プロジェクト説明】
{project_description}

【指示】
1. 上記の説明から、解決したい課題、ターゲットユーザー、プロダクトの特徴を推測してください
2. 選択肢形式の項目は、提供された選択肢から最も適切なものを選んでください
3. 自由記述項目は、具体的で実現可能な内容を記述してください
4. すべての項目について、根拠のある推論を行ってください

【出力形式】
JSON形式で以下の構造で出力してください：
{
  "section1": { ... },
  "section2": { ... }
}
```

### 4. 信頼度スコア（confidence）
- AI推論の信頼度を0.0〜1.0の範囲で算出
- プロジェクト説明の詳細度や明確さに応じて計算
- 0.7以上を推奨、0.5未満の場合はwarningを返すことを推奨

### 5. レスポンス時間
- 目標: 3秒以内
- タイムアウト: 10秒
- タイムアウト時は500エラーを返す

### 6. キャッシュ戦略
- 同一セッションIDで複数回リクエストされた場合、キャッシュを返すことを推奨
- キャッシュ有効期限: 30分
- セクション0が更新された場合はキャッシュを無効化

## サンプルシナリオ

### シナリオ1: タスク管理アプリ

**入力（セクション0）:**
```json
{
  "project_name": "TaskMaster",
  "project_description": "忙しいビジネスパーソン向けのAI搭載タスク管理アプリ。日々のタスクを自動で整理し、優先度を提案。スケジュールの最適化も行う。"
}
```

**出力:**
```json
{
  "success": true,
  "sessionId": "8cd757f3-b508-444a-92f8-8dec84695b41",
  "suggestions": {
    "section1": {
      "problem_type": "業務効率化",
      "problem_details": ["時間不足", "情報過多"],
      "target_user": "個人",
      "target_attributes": "30代・働き盛り",
      "motivation": "効率化・時短のため"
    },
    "section2": {
      "platforms": ["Webアプリケーション", "モバイルアプリ（iOS/Android）"],
      "function_types": ["データ管理・整理", "自動化・効率化"],
      "feature_details": "AIによる自動タスク整理、優先度自動付与、スケジュール最適化提案、リマインダー機能、進捗可視化",
      "revenue_models": ["サブスクリプション"],
      "product_features": ["使いやすさ", "処理速度の速さ", "独自性・革新性"],
      "strength_details": "AIによる高精度な優先度予測とシンプルで直感的なUI設計"
    }
  },
  "confidence": 0.88,
  "timestamp": "2025-11-19T11:45:32.123Z"
}
```

### シナリオ2: オンライン学習プラットフォーム

**入力（セクション0）:**
```json
{
  "project_name": "LearnHub",
  "project_description": "プログラミングを学びたい初心者向けのオンライン学習プラットフォーム。動画講座とインタラクティブな課題で実践的に学べる。"
}
```

**出力:**
```json
{
  "success": true,
  "sessionId": "9de868g4-c619-555b-a3g9-9efda96a6c52",
  "suggestions": {
    "section1": {
      "problem_type": "学習支援",
      "problem_details": ["情報過多", "使いにくさ"],
      "target_user": "個人",
      "target_attributes": "20代・若手社会人",
      "motivation": "自己実現・成長のため"
    },
    "section2": {
      "platforms": ["Webアプリケーション"],
      "function_types": ["学習・教育", "コンテンツ作成・編集"],
      "feature_details": "動画ベースの講座、インタラクティブなコーディング課題、進捗トラッキング、コミュニティフォーラム、修了証発行",
      "revenue_models": ["サブスクリプション", "買い切り"],
      "product_features": ["使いやすさ", "楽しさ・面白さ"],
      "strength_details": "初心者に優しい段階的カリキュラムと実践的な課題設計"
    }
  },
  "confidence": 0.82,
  "timestamp": "2025-11-19T11:45:32.123Z"
}
```

## フロントエンド側の処理フロー

1. ダッシュボードでユーザーがプロジェクト説明を入力
2. セッション作成（POST `/api/v1/sessions`）
3. セクション0データ送信（POST `/api/v1/generation/{sessionId}/input/0`）
4. **AI推論リクエスト（POST `/api/v1/generation/{sessionId}/ai-suggestions`）** ← このAPI
5. 推論結果をセッションストレージに保存
6. セクション1画面で推論結果を自動選択状態で表示
7. ユーザーが確認・修正して送信
8. セクション2画面で推論結果を自動選択状態で表示
9. ユーザーが確認・修正して送信
10. AI生成開始

## 注意事項

### セキュリティ
- JWTトークンの検証を必ず実施
- セッションの所有者確認（user_idの照合）
- レートリミット: 同一ユーザーから1分間に5回まで

### パフォーマンス
- AI推論は時間がかかる可能性があるため、非同期処理を推奨
- タイムアウトを適切に設定（推奨: 10秒）
- 結果のキャッシュを活用

### エラーハンドリング
- AI APIのエラーは適切にハンドリング
- フロントエンド側ではAI推論が失敗してもユーザーは手動入力可能
- エラーログを適切に記録

### データ品質
- 選択肢は必ず定義された値から選択
- 自由記述は適切な文字数範囲で生成
- 不適切な内容のフィルタリング

## 実装優先度

- **High（必須）**: AI推論の基本機能、エラーハンドリング
- **Medium（推奨）**: キャッシュ、信頼度スコア、詳細なエラーメッセージ
- **Low（オプション）**: 複数の推論候補の提供、説明の生成

## テストケース

### 正常系
1. 明確なプロジェクト説明でAI推論が成功
2. キャッシュが正しく機能
3. 信頼度スコアが適切に計算される

### 異常系
1. セッションIDが存在しない
2. セクション0データが未入力
3. 認証トークンが無効
4. AI API がタイムアウト
5. AI API がエラーを返す

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-11-19 | 1.0.0 | 初版作成 |

